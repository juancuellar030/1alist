<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Behavior Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .btn-x {
            background: #e74c3c;
            color: white;
        }

        .btn-x:hover {
            background: #c0392b;
        }

        .btn-circle {
            background: #f39c12;
            color: white;
        }

        .btn-circle:hover {
            background: #e67e22;
        }

        .btn-delete {
            background: #95a5a6;
            color: white;
        }

        .btn-delete:hover {
            background: #7f8c8d;
        }

        .btn-clear {
            background: #9b59b6;
            color: white;
        }

        .btn-clear:hover {
            background: #8e44ad;
        }

        .btn-save {
            background: #27ae60;
            color: white;
        }

        .btn-save:hover {
            background: #229954;
        }

        .btn-load {
            background: #3498db;
            color: white;
        }

        .btn-load:hover {
            background: #2980b9;
        }

        .btn-sync {
            background: #8e44ad;
            color: white;
        }

        .btn-sync:hover {
            background: #9b59b6;
        }

        .active {
            box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        thead {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        th {
            padding: 20px 15px;
            text-align: center;
            font-weight: 700;
            color: white;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        th:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
        }

        .student-name {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
            text-align: left !important;
            min-width: 200px;
            font-size: 18px;
        }

        tbody tr {
            transition: all 0.3s ease;
            background: white;
        }

        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:hover {
            background: #e3f2fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Color-coded row states based on mark count */
        tbody tr.status-clean {
            background: linear-gradient(135deg, #d5f4e6 0%, #a8e6cf 100%) !important;
            border-left: 4px solid #27ae60;
        }

        tbody tr.status-clean:hover {
            background: linear-gradient(135deg, #c8f2dd 0%, #9de1c4 100%) !important;
        }

        tbody tr.status-warning {
            background: linear-gradient(135deg, #fff9c4 0%, #f7dc6f 100%) !important;
            border-left: 4px solid #f1c40f;
        }

        tbody tr.status-warning:hover {
            background: linear-gradient(135deg, #fff5b4 0%, #f4d03f 100%) !important;
        }

        tbody tr.status-alert {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%) !important;
            border-left: 4px solid #f39c12;
        }

        tbody tr.status-alert:hover {
            background: linear-gradient(135deg, #ffe69c 0%, #fab957 100%) !important;
        }

        tbody tr.status-danger {
            background: linear-gradient(135deg, #ffcccc 0%, #ff9999 100%) !important;
            border-left: 4px solid #e74c3c;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
        }

        tbody tr.status-danger:hover {
            background: linear-gradient(135deg, #ffbfbf 0%, #ff8080 100%) !important;
        }

        td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            position: relative;
        }

        .student-name-cell {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            text-align: left !important;
            background: rgba(52, 73, 94, 0.05);
        }

        .clickable-cell {
            cursor: pointer;
            min-width: 60px;
            min-height: 60px;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.2s ease;
            position: relative;
            vertical-align: middle;
        }

        .clickable-cell:hover {
            background: #e8f5e8;
            transform: scale(1.1);
        }

        .clickable-cell.has-mark {
            background: #f8f9fa;
        }

        .mark-x {
            color: #e74c3c;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .mark-circle {
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .clickable-cell {
            border-right: 1px solid #dee2e6;
        }

        /* Thicker borders between day sections */
        .clickable-cell[data-day="monday5"] {
            border-right: 3px solid #95a5a6;
        }

        .clickable-cell[data-day="wednesday5"] {
            border-right: 3px solid #95a5a6;
        }

        .status-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .warning .status-indicator {
            background: #e74c3c;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                font-size: 2rem;
            }

            .controls {
                justify-content: center;
            }

            .table-container {
                padding: 15px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 12px;
            }
        }

        .week-info {
            background: #ecf0f1;
            padding: 15px 30px;
            border-bottom: 1px solid #bdc3c7;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Student Behavior Tracker</h1>
            <div class="controls">
                <button class="btn btn-x" id="markX">‚úó Mark X</button>
                <button class="btn btn-circle" id="markCircle">‚óè Mark O</button>
                <button class="btn btn-delete" id="deleteMark">üóë Delete Mark</button>
                <button class="btn btn-clear" id="clearAll">üîÑ Clear All</button>
                <button class="btn btn-save" id="saveData">üíæ Save Data</button>
                <button class="btn btn-load" id="loadData">üìÇ Load Data</button>
                <button class="btn btn-sync" id="syncToSheets">‚òÅÔ∏è Sync to Sheets</button>
                <button class="btn btn-sync" id="loadFromSheets">üì• Load from Sheets</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
        </div>
        
        <div class="week-info" id="weekInfo">
            Week of <span id="currentWeek"></span>
            <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                <strong>üìä Status Legend:</strong> 
                <span style="background: #d5f4e6; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">üü¢ Clean (0 marks)</span>
                <span style="background: #fff9c4; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">üü° Warning (1 mark)</span>
                <span style="background: #ffeaa7; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">üü† Alert (2 marks)</span>
                <span style="background: #ffcccc; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">üî¥ Danger (3+ marks)</span>
            </div>
        </div>

        <div class="table-container">
            <table id="behaviorTable">
                <thead>
                    <tr>
                        <th class="student-name">Student Name</th>
                        <th colspan="5">Monday (5 periods)</th>
                        <th colspan="5">Wednesday (5 periods)</th>
                        <th colspan="7">Thursday (7 periods)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Students will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Student list from the document
        const students = [
            'CELESTE DE LA HOZ',
            'DAVID SANTIAGO',
            'DULCE XCARET',
            'EMILIO VARGAS',
            'EMMANUEL M.',
            'HELENA FRANCO',
            'IKER JULI√ÅN',
            'JER√ìNIMO R.',
            'JOS√â DANIEL',
            'JUAN DAVID G.',
            'JUAN PABLO',
            'LUNA CAROLINA',
            'MARIA LUISA',
            'MARIA V. HURTADO',
            'MARIA V. PE√ëA',
            'MART√çN TOVAR',
            'SAMUEL MELO',
            'SARA MAR√çA',
            'SARAY MORALES',
            'VICTORIA CADENA',
            'VIOLETA CASTA√ëO'
        ];

        let currentMode = null;
        let behaviorData = {};
        
        // Google Sheets configuration
        const SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwwOmCxyOC1ndRsdE5rNnJpRtiWW-nwKGiSyF3bPvJTSVV60LYpZd92Zj1QCNxMUcbj/exec'; // Replace with your actual URL

        // Initialize behavior data structure
        function initializeBehaviorData() {
            students.forEach(student => {
                behaviorData[student] = {
                    monday1: '',
                    monday2: '',
                    monday3: '',
                    monday4: '',
                    monday5: '',
                    wednesday1: '',
                    wednesday2: '',
                    wednesday3: '',
                    wednesday4: '',
                    wednesday5: '',
                    thursday1: '',
                    thursday2: '',
                    thursday3: '',
                    thursday4: '',
                    thursday5: '',
                    thursday6: '',
                    thursday7: ''
                };
            });
        }

        // Get current week date range
        function getCurrentWeek() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
            
            const friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);
            
            const options = { month: 'short', day: 'numeric' };
            return `${monday.toLocaleDateString('en-US', options)} - ${friday.toLocaleDateString('en-US', options)}`;
        }

        // Update week display
        function updateWeekDisplay() {
            document.getElementById('currentWeek').textContent = getCurrentWeek();
        }

        // Check if it's a new week and update display
        function checkAndUpdateWeek() {
            const currentWeekText = getCurrentWeek();
            const displayedWeek = document.getElementById('currentWeek').textContent;
            
            if (currentWeekText !== displayedWeek) {
                updateWeekDisplay();
                // Optionally prompt to clear data for new week
                if (confirm('It\'s a new week! Would you like to clear all marks and start fresh?')) {
                    initializeBehaviorData();
                    document.querySelectorAll('.clickable-cell').forEach(cell => {
                        cell.textContent = '';
                        cell.className = 'clickable-cell';
                    });
                    document.querySelectorAll('tbody tr').forEach(row => {
                        row.classList.remove('warning');
                    });
                }
            }
        }

        // Create table
        function createTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="student-name-cell">${student}</td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday1"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday2"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday3"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday4"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday5"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday1"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday2"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday3"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday4"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday5"></td>
                    <td class="clickable-cell thursday-cell" data-student="${student}" data-day="thursday1"></td>
                    <td class="clickable-cell thursday-cell" data-student="${student}" data-day="thursday2"></td>
                    <td class="clickable-cell thursday-cell" data-student="${student}" data-day="thursday3"></td>
                    <td class="clickable-cell thursday-cell" data-student="${student}" data-day="thursday4"></td>
                    <td class="clickable-cell thursday-cell" data-student="${student}" data-day="thursday5"></td>
                    <td class="clickable-cell thursday-cell" data-student="${student}" data-day="thursday6"></td>
                    <td class="clickable-cell thursday-cell" data-student="${student}" data-day="thursday7"></td>
                `;
                tableBody.appendChild(row);
            });

            // Add click listeners to cells
            document.querySelectorAll('.clickable-cell').forEach(cell => {
                cell.addEventListener('click', handleCellClick);
            });
        }

        // Handle cell clicks
        function handleCellClick(event) {
            const cell = event.target;
            const student = cell.dataset.student;
            const day = cell.dataset.day;

            if (!currentMode) return;

            switch (currentMode) {
                case 'x':
                    behaviorData[student][day] = 'X';
                    cell.textContent = '‚úó';
                    cell.className = 'clickable-cell has-mark mark-x';
                    break;
                case 'circle':
                    behaviorData[student][day] = 'O';
                    cell.textContent = '‚óè';
                    cell.className = 'clickable-cell has-mark mark-circle';
                    break;
                case 'delete':
                    behaviorData[student][day] = '';
                    cell.textContent = '';
                    cell.className = 'clickable-cell';
                    break;
            }

            updateRowStatus(student);
            clearMode();
        }

        // Update row status based on marks
        function updateRowStatus(student) {
            const row = document.querySelector(`[data-student="${student}"]`).closest('tr');
            const marks = Object.values(behaviorData[student]).filter(mark => mark !== '');
            const markCount = marks.length;
            
            // Remove all status classes
            row.classList.remove('status-clean', 'status-warning', 'status-alert', 'status-danger');
            
            // Apply appropriate status class based on mark count
            if (markCount === 0) {
                row.classList.add('status-clean');
            } else if (markCount === 1) {
                row.classList.add('status-warning');
            } else if (markCount === 2) {
                row.classList.add('status-alert');
            } else if (markCount >= 3) {
                row.classList.add('status-danger');
            }
        }

        // Set mode
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(getButtonId(mode)).classList.add('active');
        }

        // Clear mode
        function clearMode() {
            // Only clear mode for delete action, keep marking modes active
            if (currentMode === 'delete') {
                currentMode = null;
                document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            }
        }

        // Get button ID from mode
        function getButtonId(mode) {
            switch (mode) {
                case 'x': return 'markX';
                case 'circle': return 'markCircle';
                case 'delete': return 'deleteMark';
                default: return '';
            }
        }

        // Clear all marks
        function clearAllMarks() {
            if (confirm('Are you sure you want to clear all marks for the week?')) {
                initializeBehaviorData();
                document.querySelectorAll('.clickable-cell').forEach(cell => {
                    cell.textContent = '';
                    cell.className = 'clickable-cell';
                });
                document.querySelectorAll('tbody tr').forEach(row => {
                    row.className = '';
                    row.classList.add('status-clean');
                });
            }
        }

        // Save data to JSON file
        function saveData() {
            console.log('Save button clicked');
            try {
                const currentWeek = getCurrentWeek();
                const dataToSave = {
                    week: currentWeek,
                    savedDate: new Date().toISOString(),
                    behaviorData: behaviorData
                };
                
                const dataStr = JSON.stringify(dataToSave, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `student-behavior-${currentWeek.replace(/[^a-zA-Z0-9]/g, '-')}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show confirmation
                const saveBtn = document.getElementById('saveData');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '‚úÖ Saved!';
                saveBtn.style.background = '#27ae60';
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.background = '';
                }, 2000);
                
                console.log('Save completed successfully');
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data. Please try again.');
            }
        }

        // Load data from JSON file
        function loadData() {
            console.log('Load button clicked');
            try {
                const fileInput = document.getElementById('fileInput');
                fileInput.click();
                console.log('File input triggered');
            } catch (error) {
                console.error('Error triggering file input:', error);
                alert('Error opening file picker. Please try again.');
            }
        }

        // Handle file selection
        function handleFileSelect(event) {
            console.log('File selected:', event.target.files[0]);
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('File read successfully');
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        console.log('Data parsed:', loadedData);
                        
                        if (loadedData.behaviorData && loadedData.week) {
                            // Confirm loading
                            const confirmLoad = confirm(
                                `Load data from ${loadedData.week}?\n` +
                                `Saved on: ${new Date(loadedData.savedDate).toLocaleDateString()}\n\n` +
                                'This will replace current marks.'
                            );
                            
                            if (confirmLoad) {
                                behaviorData = loadedData.behaviorData;
                                updateTableDisplay();
                                
                                // Show confirmation
                                const loadBtn = document.getElementById('loadData');
                                const originalText = loadBtn.textContent;
                                loadBtn.textContent = '‚úÖ Loaded!';
                                loadBtn.style.background = '#3498db';
                                setTimeout(() => {
                                    loadBtn.textContent = originalText;
                                    loadBtn.style.background = '';
                                }, 2000);
                                
                                console.log('Data loaded successfully');
                            }
                        } else {
                            alert('Invalid file format. Please select a valid behavior data file.');
                        }
                    } catch (parseError) {
                        console.error('Parse error:', parseError);
                        alert('Error reading file. Please make sure it\'s a valid JSON file.');
                    }
                };
                reader.onerror = function(error) {
                    console.error('File read error:', error);
                    alert('Error reading file. Please try again.');
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error handling file:', error);
                alert('Error processing file. Please try again.');
            }
            
            // Reset file input
            event.target.value = '';
        }

        // Update table display with loaded data
        function updateTableDisplay() {
            document.querySelectorAll('.clickable-cell').forEach(cell => {
                const student = cell.dataset.student;
                const day = cell.dataset.day;
                const mark = behaviorData[student][day];
                
                cell.textContent = '';
                cell.className = 'clickable-cell';
                
                if (mark === 'X') {
                    cell.textContent = '‚úó';
                    cell.className = 'clickable-cell has-mark mark-x';
                } else if (mark === 'O') {
                    cell.textContent = '‚óè';
                    cell.className = 'clickable-cell has-mark mark-circle';
                }
            });
            
            // Update row warnings
            students.forEach(student => {
                updateRowStatus(student);
            });
        }

        // Sync data to Google Sheets
        async function syncToSheets() {
            if (!SHEETS_WEB_APP_URL || SHEETS_WEB_APP_URL === 'https://script.google.com/macros/s/AKfycbwwOmCxyOC1ndRsdE5rNnJpRtiWW-nwKGiSyF3bPvJTSVV60LYpZd92Zj1QCNxMUcbj/exec') {
                alert('Please configure your Google Sheets Web App URL first!\n\nSee the setup instructions in the console.');
                console.log(`
üîß GOOGLE SHEETS SETUP REQUIRED:

1. Create a Google Sheet with your behavior data
2. Go to Extensions ‚Üí Apps Script
3. Paste the provided script code
4. Deploy as Web App
5. Copy the Web App URL
6. Replace 'YOUR_WEB_APP_URL_HERE' in the code with your actual URL

Then try syncing again!
                `);
                return;
            }

            try {
                const syncBtn = document.getElementById('syncToSheets');
                syncBtn.textContent = '‚è≥ Syncing...';
                syncBtn.disabled = true;

                const dataToSync = {
                    action: 'save',
                    week: getCurrentWeek(),
                    behaviorData: behaviorData,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSync)
                });

                const result = await response.json();
                
                if (result.success) {
                    syncBtn.textContent = '‚úÖ Synced!';
                    syncBtn.style.background = '#27ae60';
                    setTimeout(() => {
                        syncBtn.textContent = '‚òÅÔ∏è Sync to Sheets';
                        syncBtn.style.background = '';
                        syncBtn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                alert('Error syncing to Google Sheets. Check console for details.');
                const syncBtn = document.getElementById('syncToSheets');
                syncBtn.textContent = '‚òÅÔ∏è Sync to Sheets';
                syncBtn.disabled = false;
            }
        }

        // Load data from Google Sheets
        async function loadFromSheets() {
            if (!SHEETS_WEB_APP_URL || SHEETS_WEB_APP_URL === 'https://script.google.com/macros/s/AKfycbwwOmCxyOC1ndRsdE5rNnJpRtiWW-nwKGiSyF3bPvJTSVV60LYpZd92Zj1QCNxMUcbj/exec') {
                alert('Please configure your Google Sheets Web App URL first!');
                return;
            }

            try {
                const loadBtn = document.getElementById('loadFromSheets');
                loadBtn.textContent = '‚è≥ Loading...';
                loadBtn.disabled = true;

                const dataToSend = {
                    action: 'load',
                    week: getCurrentWeek()
                };

                const response = await fetch(SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();
                
                if (result.success) {
                    const confirmLoad = confirm(
                        `Load data from Google Sheets for ${result.week}?\n\n` +
                        'This will replace current marks.'
                    );
                    
                    if (confirmLoad) {
                        behaviorData = result.behaviorData;
                        updateTableDisplay();
                        
                        loadBtn.textContent = '‚úÖ Loaded!';
                        loadBtn.style.background = '#3498db';
                        setTimeout(() => {
                            loadBtn.textContent = 'üì• Load from Sheets';
                            loadBtn.style.background = '';
                            loadBtn.disabled = false;
                        }, 2000);
                    } else {
                        loadBtn.textContent = 'üì• Load from Sheets';
                        loadBtn.disabled = false;
                    }
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Load error:', error);
                alert('Error loading from Google Sheets. Check console for details.');
                const loadBtn = document.getElementById('loadFromSheets');
                loadBtn.textContent = 'üì• Load from Sheets';
                loadBtn.disabled = false;
            }
        }

        // Initialize
        document.getElementById('currentWeek').textContent = getCurrentWeek();
        initializeBehaviorData();
        createTable();

        // Event listeners (attach after DOM is ready)
        document.getElementById('markX').addEventListener('click', () => setMode('x'));
        document.getElementById('markCircle').addEventListener('click', () => setMode('circle'));
        document.getElementById('deleteMark').addEventListener('click', () => setMode('delete'));
        document.getElementById('clearAll').addEventListener('click', clearAllMarks);
        document.getElementById('saveData').addEventListener('click', saveData);
        document.getElementById('loadData').addEventListener('click', loadData);
        document.getElementById('syncToSheets').addEventListener('click', syncToSheets);
        document.getElementById('loadFromSheets').addEventListener('click', loadFromSheets);
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // Check for week changes every hour
        setInterval(checkAndUpdateWeek, 60 * 60 * 1000);

        // Also check when the page becomes visible again (user returns to tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                checkAndUpdateWeek();
            }
        });

        // Clear mode when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.controls') && !e.target.closest('.clickable-cell')) {
                if (currentMode === 'delete') {
                    currentMode = null;
                    document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                }
            }
        });
    </script>
</body>
</html>
