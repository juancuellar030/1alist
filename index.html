<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Behavior Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-circle {
            background: #f39c12;
            color: white;
        }

        .btn-circle:hover {
            background: #e67e22;
        }

        .btn-circle.active {
            background: #e67e22;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .btn-finish {
            background: #2ecc71;
            color: white;
        }

        .btn-finish:hover {
            background: #27ae60;
        }

        .btn-clear {
            background: #9b59b6;
            color: white;
        }

        .btn-clear:hover {
            background: #8e44ad;
        }

        .btn-save {
            background: #27ae60;
            color: white;
        }

        .btn-save:hover {
            background: #229954;
        }

        .btn-load {
            background: #3498db;
            color: white;
        }

        .btn-load:hover {
            background: #2980b9;
        }

        .btn-sync {
            background: #8e44ad;
            color: white;
        }

        .week-selector-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .week-selector {
            padding: 12px 16px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .week-selector:hover {
            border-color: #2980b9;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .week-selector:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        thead {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        th {
            padding: 20px 15px;
            text-align: center;
            font-weight: 700;
            color: white;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        th:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
        }

        .student-name {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
            text-align: left !important;
            min-width: 200px;
            font-size: 18px;
        }

        tbody tr {
            transition: all 0.3s ease;
            background: white;
        }

        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:hover {
            background: #e3f2fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        tbody tr.status-clean {
            background: linear-gradient(135deg, #d5f4e6 0%, #a8e6cf 100%) !important;
            border-left: 4px solid #27ae60;
        }

        tbody tr.status-clean:hover {
            background: linear-gradient(135deg, #c8f2dd 0%, #9de1c4 100%) !important;
        }

        tbody tr.status-warning {
            background: linear-gradient(135deg, #f7f1a8 0%, #d4e6a3 100%) !important;
            border-left: 4px solid #8bc34a;
        }

        tbody tr.status-warning:hover {
            background: linear-gradient(135deg, #f4ed9f 0%, #cfe09a 100%) !important;
        }

        tbody tr.status-alert {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%) !important;
            border-left: 4px solid #f39c12;
        }

        tbody tr.status-alert:hover {
            background: linear-gradient(135deg, #ffe69c 0%, #fab957 100%) !important;
        }

        tbody tr.status-danger {
            background: linear-gradient(135deg, #ffcccc 0%, #ff9999 100%) !important;
            border-left: 4px solid #e74c3c;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
        }

        tbody tr.status-danger:hover {
            background: linear-gradient(135deg, #ffbfbf 0%, #ff8080 100%) !important;
        }

        tbody tr.week-completed {
            background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%) !important;
            border-left: 4px solid #00b894;
            box-shadow: 0 2px 8px rgba(0, 184, 148, 0.2);
        }

        tbody tr.week-completed:hover {
            background: linear-gradient(135deg, #9de1c4 0%, #74c0c0 100%) !important;
        }

        tbody tr.week-completed.status-warning {
            background: linear-gradient(135deg, #f7f1a8 0%, #d4e6a3 100%) !important;
            border-left: 4px solid #8bc34a;
        }

        tbody tr.week-completed.status-alert {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%) !important;
            border-left: 4px solid #f39c12;
        }

        tbody tr.week-completed.status-danger {
            background: linear-gradient(135deg, #ffcccc 0%, #ff9999 100%) !important;
            border-left: 4px solid #e74c3c;
        }

        td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            position: relative;
        }

        .student-name-cell {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            text-align: left !important;
            background: rgba(52, 73, 94, 0.05);
        }

        .clickable-cell {
            cursor: pointer;
            min-width: 60px;
            min-height: 60px;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.2s ease;
            position: relative;
            vertical-align: middle;
        }

        .clickable-cell:hover {
            background: #e8f5e8;
            transform: scale(1.1);
        }

        .clickable-cell.has-mark {
            background: #f8f9fa;
        }

        .mark-x {
            color: #e74c3c;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-family: 'Arial Black', sans-serif;
            font-weight: 900;
            font-size: 28px;
        }

        .mark-circle {
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .clickable-cell[data-day="monday5"] {
            border-right: 3px solid #95a5a6;
        }

        .clickable-cell[data-day="wednesday5"] {
            border-right: 3px solid #95a5a6;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                font-size: 2rem;
            }

            .controls {
                justify-content: center;
            }

            .table-container {
                padding: 15px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 12px;
            }
        }

        .week-info {
            background: #ecf0f1;
            padding: 15px 30px;
            border-bottom: 1px solid #bdc3c7;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #c62828;
            font-family: monospace;
            font-size: 12px;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Student Behavior Tracker</h1>
            <div class="controls">
                <button class="btn btn-circle" id="markCircle">● Circle Mode</button>
                <button class="btn btn-finish" id="finishWeek">🏁 Finish Week</button>
                <button class="btn btn-clear" id="clearAll">🔥 Clear All</button>
                <button class="btn btn-save" id="saveData">💾 Save Data</button>
                <button class="btn btn-load" id="loadData">📂 Load Data</button>
                <div class="week-selector-group">
                    <select id="weekSelector" class="week-selector">
                        <option value="current">Current Week</option>
                    </select>
                    <button class="btn btn-sync" id="syncToSheets">☁️ Sync to Sheets</button>
                    <button class="btn btn-sync" id="loadFromSheets">📥 Load from Sheets</button>
                </div>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
        </div>
        
        <div class="week-info" id="weekInfo">
            Week of <span id="currentWeek"></span>
            <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                <strong>📊 Status Legend:</strong> 
                <span style="background: #d5f4e6; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">🟢 Clean (0 marks)</span>
                <span style="background: #f7f1a8; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">🟡 Warning (1 mark)</span>
                <span style="background: #ffeaa7; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">🟠 Alert (2 marks)</span>
                <span style="background: #ffcccc; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">🔴 Danger (3+ marks)</span>
                <span style="background: #a8e6cf; padding: 2px 8px; border-radius: 4px; margin: 0 5px;">✅ Week Completed</span>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #95a5a6;">
                <strong>💡 Usage:</strong> Click cells to add/remove X marks | Use Circle Mode for O marks | Finish Week to lock clean records
            </div>
            <div id="debugInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
        </div>

        <div class="table-container">
            <table id="behaviorTable">
                <thead>
                    <tr>
                        <th class="student-name">Student Name</th>
                        <th colspan="5">Monday (5 periods)</th>
                        <th colspan="5">Wednesday (5 periods)</th>
                        <th colspan="7">Thursday (7 periods)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwWRwrfiWnMvJBD6uxUwUY8iso18veUIIFfcP3zpuZzjB8f7ai3I4Q9T3pubGphPOYgJw/exec';
        
        const students = [
            'CELESTE DE LA HOZ', 'DAVID SANTIAGO', 'DULCE XCARET', 'EMILIO VARGAS', 'EMMANUEL M.',
            'HELENA FRANCO', 'IKER JULIÁN', 'JERÓNIMO R.', 'JOSÉ DANIEL', 'JUAN DAVID G.',
            'JUAN PABLO', 'LUNA CAROLINA', 'MARIA LUISA', 'MARIA V. HURTADO', 'MARIA V. PEÑA',
            'MARTÍN TOVAR', 'SAMUEL MELO', 'SARA MARÍA', 'SARAY MORALES', 'VICTORIA CADENA', 'VIOLETA CASTAÑO'
        ];

        let circleMode = false;
        let weekCompleted = false;
        let behaviorData = {};
        let selectedWeek = null;
        let hasUnsavedData = false;

        function debugLog(message, data = null) {
            console.log('[DEBUG]', message, data);
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML = `<strong>${timestamp}:</strong> ${message}${data ? ' - Check console' : ''}`;
        }

        function showError(message, error = null) {
            console.error('[ERROR]', message, error);
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `<div class="error-message"><strong>Error:</strong> ${message}${error ? '<br>Details: ' + error.message : ''}</div>`;
        }

        function showSuccess(message) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `<div class="success-message"><strong>Success:</strong> ${message}</div>`;
            setTimeout(() => { debugDiv.innerHTML = ''; }, 5000);
        }

        function initializeBehaviorData() {
            students.forEach(student => {
                behaviorData[student] = {
                    monday1: '', monday2: '', monday3: '', monday4: '', monday5: '',
                    wednesday1: '', wednesday2: '', wednesday3: '', wednesday4: '', wednesday5: '',
                    thursday1: '', thursday2: '', thursday3: '', thursday4: '', thursday5: '', thursday6: '', thursday7: ''
                };
            });
        }

        function getCurrentWeek() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
            const friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);
            const options = { month: 'short', day: 'numeric' };
            return `${monday.toLocaleDateString('en-US', options)} - ${friday.toLocaleDateString('en-US', options)}`;
        }

        function getSelectedWeek() {
            return (selectedWeek && selectedWeek !== 'current') ? selectedWeek : getCurrentWeek();
        }

        function generateWeekOptions() {
            const weekSelector = document.getElementById('weekSelector');
            const currentWeek = getCurrentWeek();
            weekSelector.innerHTML = `<option value="current">Current Week (${currentWeek})</option>`;
            
            for (let i = 1; i <= 4; i++) {
                const pastDate = new Date();
                pastDate.setDate(pastDate.getDate() - (i * 7));
                const monday = new Date(pastDate);
                monday.setDate(pastDate.getDate() - (pastDate.getDay() === 0 ? 6 : pastDate.getDay() - 1));
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4);
                const options = { month: 'short', day: 'numeric' };
                const weekString = `${monday.toLocaleDateString('en-US', options)} - ${friday.toLocaleDateString('en-US', options)}`;
                const option = document.createElement('option');
                option.value = weekString;
                option.textContent = weekString;
                weekSelector.appendChild(option);
            }
            
            for (let i = 1; i <= 2; i++) {
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + (i * 7));
                const monday = new Date(futureDate);
                monday.setDate(futureDate.getDate() - (futureDate.getDay() === 0 ? 6 : futureDate.getDay() - 1));
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4);
                const options = { month: 'short', day: 'numeric' };
                const weekString = `${monday.toLocaleDateString('en-US', options)} - ${friday.toLocaleDateString('en-US', options)}`;
                const option = document.createElement('option');
                option.value = weekString;
                option.textContent = weekString;
                weekSelector.appendChild(option);
            }
        }

        function handleWeekChange() {
            selectedWeek = document.getElementById('weekSelector').value;
            document.getElementById('currentWeek').textContent = getSelectedWeek();
            debugLog(`Week changed to: ${getSelectedWeek()}`);
        }

        function createTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="student-name-cell">${student}</td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday1"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday2"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday3"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday4"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="monday5"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday1"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday2"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday3"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday4"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="wednesday5"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="thursday1"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="thursday2"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="thursday3"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="thursday4"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="thursday5"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="thursday6"></td>
                    <td class="clickable-cell" data-student="${student}" data-day="thursday7"></td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.clickable-cell').forEach(cell => {
                cell.addEventListener('click', handleCellClick);
            });
        }

        function handleCellClick(event) {
            hasUnsavedData = true;
            const cell = event.target;
            const student = cell.dataset.student;
            const day = cell.dataset.day;
            const currentValue = behaviorData[student][day];

            if (circleMode) {
                if (currentValue === 'O') {
                    behaviorData[student][day] = '';
                    cell.textContent = '';
                    cell.className = 'clickable-cell';
                } else {
                    behaviorData[student][day] = 'O';
                    cell.textContent = '●';
                    cell.className = 'clickable-cell has-mark mark-circle';
                }
            } else {
                if (currentValue === 'X') {
                    behaviorData[student][day] = '';
                    cell.textContent = '';
                    cell.className = 'clickable-cell';
                } else {
                    behaviorData[student][day] = 'X';
                    cell.textContent = '✗';
                    cell.className = 'clickable-cell has-mark mark-x';
                }
            }
            updateRowStatus(student);
        }

        function updateRowStatus(student) {
            const row = document.querySelector(`[data-student="${student}"]`).closest('tr');
            const marks = Object.values(behaviorData[student]).filter(mark => mark !== '');
            const markCount = marks.length;
            const wasWeekCompleted = row.classList.contains('week-completed');
            row.classList.remove('status-clean', 'status-warning', 'status-alert', 'status-danger');
            
            if (markCount === 0) {
                if (wasWeekCompleted) row.classList.add('status-clean', 'week-completed');
            } else if (markCount === 1) {
                row.classList.add('status-warning');
                if (wasWeekCompleted) row.classList.add('week-completed');
            } else if (markCount === 2) {
                row.classList.add('status-alert');
                if (wasWeekCompleted) row.classList.add('week-completed');
            } else {
                row.classList.add('status-danger');
                if (wasWeekCompleted) row.classList.add('week-completed');
            }
        }

        function toggleCircleMode() {
            circleMode = !circleMode;
            const button = document.getElementById('markCircle');
            if (circleMode) {
                button.classList.add('active');
                button.textContent = '● Circle Mode (ON)';
            } else {
                button.classList.remove('active');
                button.textContent = '● Circle Mode';
            }
        }

        function finishWeek() {
            if (weekCompleted) {
                if (confirm('Week is already finished. Reset week status?')) {
                    weekCompleted = false;
                    document.querySelectorAll('tbody tr').forEach(row => row.classList.remove('week-completed'));
                    students.forEach(student => updateRowStatus(student));
                    document.getElementById('finishWeek').textContent = '🏁 Finish Week';
                    document.getElementById('finishWeek').style.background = '';
                    showSuccess('Week status reset');
                }
                return;
            }

            if (confirm('Mark this week as completed?')) {
                weekCompleted = true;
                let cleanStudents = 0;
                students.forEach(student => {
                    const marks = Object.values(behaviorData[student]).filter(mark => mark !== '');
                    const row = document.querySelector(`[data-student="${student}"]`).closest('tr');
                    row.classList.add('week-completed');
                    updateRowStatus(student);
                    if (marks.length === 0) cleanStudents++;
                });
                const finishBtn = document.getElementById('finishWeek');
                finishBtn.textContent = '✅ Week Completed';
                finishBtn.style.background = '#00b894';
                showSuccess(`Week completed! ${cleanStudents} students had clean records.`);
            }
        }

        function clearAllMarks() {
            if (confirm('Clear all marks and week status?')) {
                weekCompleted = false;
                initializeBehaviorData();
                document.querySelectorAll('.clickable-cell').forEach(cell => {
                    cell.textContent = '';
                    cell.className = 'clickable-cell';
                });
                document.querySelectorAll('tbody tr').forEach(row => row.className = '');
                document.getElementById('finishWeek').textContent = '🏁 Finish Week';
                document.getElementById('finishWeek').style.background = '';
                showSuccess('All marks cleared');
            }
        }

        function saveData() {
            hasUnsavedData = false;
            try {
                const dataToSave = {
                    week: getCurrentWeek(),
                    savedDate: new Date().toISOString(),
                    weekCompleted: weekCompleted,
                    behaviorData: behaviorData
                };
                const dataStr = JSON.stringify(dataToSave, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `student-behavior-${getCurrentWeek().replace(/[^a-zA-Z0-9]/g, '-')}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                const saveBtn = document.getElementById('saveData');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '✅ Saved!';
                saveBtn.style.background = '#27ae60';
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.background = '';
                }, 2000);
                showSuccess('Data saved to file');
            } catch (error) {
                showError('Error saving data', error);
            }
        }

        function loadData() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (loadedData.behaviorData && loadedData.week) {
                        if (confirm(`Load data from ${loadedData.week}?\nSaved: ${new Date(loadedData.savedDate).toLocaleDateString()}\n\nThis will replace current marks.`)) {
                            behaviorData = loadedData.behaviorData;
                            weekCompleted = loadedData.weekCompleted || false;
                            updateTableDisplay();
                            
                            const finishBtn = document.getElementById('finishWeek');
                            if (weekCompleted) {
                                finishBtn.textContent = '✅ Week Completed';
                                finishBtn.style.background = '#00b894';
                            } else {
                                finishBtn.textContent = '🏁 Finish Week';
                                finishBtn.style.background = '';
                            }
                            
                            const loadBtn = document.getElementById('loadData');
                            const originalText = loadBtn.textContent;
                            loadBtn.textContent = '✅ Loaded!';
                            loadBtn.style.background = '#3498db';
                            setTimeout(() => {
                                loadBtn.textContent = originalText;
                                loadBtn.style.background = '';
                            }, 2000);
                            showSuccess(`Data loaded from ${loadedData.week}`);
                        }
                    } else {
                        showError('Invalid file format');
                    }
                } catch (error) {
                    showError('Error parsing file', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function updateTableDisplay() {
            document.querySelectorAll('.clickable-cell').forEach(cell => {
                const student = cell.dataset.student;
                const day = cell.dataset.day;
                const mark = behaviorData[student][day];
                
                cell.textContent = '';
                cell.className = 'clickable-cell';
                
                if (mark === 'X') {
                    cell.textContent = '✗';
                    cell.className = 'clickable-cell has-mark mark-x';
                } else if (mark === 'O') {
                    cell.textContent = '●';
                    cell.className = 'clickable-cell has-mark mark-circle';
                }
            });
            students.forEach(student => updateRowStatus(student));
        }

        async function testSheetsConnection() {
            debugLog('Testing Google Sheets connection...');
            try {
                const response = await fetch(SHEETS_WEB_APP_URL, { method: 'GET' });
                const result = await response.json();
                if (result.success) {
                    showSuccess('Google Sheets connection successful!');
                    return true;
                } else {
                    showError('Connection test failed', new Error(result.message));
                    return false;
                }
            } catch (error) {
                showError('Connection test failed', error);
                return false;
            }
        }

        async function syncToSheets() {
            debugLog('Syncing to Sheets...');
            
            if (!SHEETS_WEB_APP_URL || SHEETS_WEB_APP_URL.includes('YOUR_WEB_APP_URL_HERE')) {
                showError('Please configure your Google Sheets Web App URL first!');
                return;
            }

            try {
                const syncBtn = document.getElementById('syncToSheets');
                const originalText = syncBtn.textContent;
                syncBtn.textContent = '⏳ Syncing...';
                syncBtn.disabled = true;

                const dataToSync = {
                    action: 'save',
                    week: getSelectedWeek(),
                    weekCompleted: weekCompleted,
                    behaviorData: behaviorData,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(dataToSync)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    hasUnsavedData = false;
                    syncBtn.textContent = '✅ Synced!';
                    syncBtn.style.background = '#27ae60';
                    showSuccess(`Data synced! ${result.studentsUpdated} students updated.`);
                    
                    setTimeout(() => {
                        syncBtn.textContent = originalText;
                        syncBtn.style.background = '';
                        syncBtn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Unknown sync error');
                }
            } catch (error) {
                showError('Error syncing to Google Sheets', error);
                const syncBtn = document.getElementById('syncToSheets');
                syncBtn.textContent = '☁️ Sync to Sheets';
                syncBtn.disabled = false;
            }
        }

        async function loadFromSheets() {
            debugLog('Loading from Sheets...');
            
            if (!SHEETS_WEB_APP_URL || SHEETS_WEB_APP_URL.includes('YOUR_WEB_APP_URL_HERE')) {
                showError('Please configure your Google Sheets Web App URL first!');
                return;
            }

            try {
                const loadBtn = document.getElementById('loadFromSheets');
                const originalText = loadBtn.textContent;
                loadBtn.textContent = '⏳ Loading...';
                loadBtn.disabled = true;

                const dataToSend = {
                    action: 'load',
                    week: getSelectedWeek()
                };

                const response = await fetch(SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(dataToSend)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    if (confirm(`Load data from Google Sheets for ${result.week}?\nFound ${result.studentsLoaded} students.\n\nThis will replace current marks.`)) {
                        behaviorData = result.behaviorData;
                        weekCompleted = result.weekCompleted || false;
                        updateTableDisplay();
                        
                        const finishBtn = document.getElementById('finishWeek');
                        if (weekCompleted) {
                            finishBtn.textContent = '✅ Week Completed';
                            finishBtn.style.background = '#00b894';
                        } else {
                            finishBtn.textContent = '🏁 Finish Week';
                            finishBtn.style.background = '';
                        }
                        
                        loadBtn.textContent = '✅ Loaded!';
                        loadBtn.style.background = '#3498db';
                        showSuccess(`Data loaded! ${result.studentsLoaded} students loaded.`);
                        
                        setTimeout(() => {
                            loadBtn.textContent = originalText;
                            loadBtn.style.background = '';
                            loadBtn.disabled = false;
                        }, 3000);
                    } else {
                        loadBtn.textContent = originalText;
                        loadBtn.disabled = false;
                    }
                } else {
                    if (result.error && result.error.includes('No data found')) {
                        showError(`No data found in Google Sheets for week: ${getSelectedWeek()}`);
                    } else {
                        throw new Error(result.error || 'Unknown load error');
                    }
                    loadBtn.textContent = originalText;
                    loadBtn.disabled = false;
                }
            } catch (error) {
                showError('Error loading from Google Sheets', error);
                const loadBtn = document.getElementById('loadFromSheets');
                loadBtn.textContent = '📥 Load from Sheets';
                loadBtn.disabled = false;
            }
        }

        function initialize() {
            debugLog('Initializing Student Behavior Tracker');
            generateWeekOptions();
            document.getElementById('currentWeek').textContent = getSelectedWeek();
            initializeBehaviorData();
            createTable();
            debugLog('Initialization complete');
            
            if (SHEETS_WEB_APP_URL && !SHEETS_WEB_APP_URL.includes('YOUR_WEB_APP_URL_HERE')) {
                setTimeout(testSheetsConnection, 1000);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM loaded, setting up event listeners');
            
            document.getElementById('markCircle').addEventListener('click', toggleCircleMode);
            document.getElementById('finishWeek').addEventListener('click', finishWeek);
            document.getElementById('clearAll').addEventListener('click', clearAllMarks);
            document.getElementById('saveData').addEventListener('click', saveData);
            document.getElementById('loadData').addEventListener('click', loadData);
            document.getElementById('syncToSheets').addEventListener('click', syncToSheets);
            document.getElementById('loadFromSheets').addEventListener('click', loadFromSheets);
            document.getElementById('weekSelector').addEventListener('change', handleWeekChange);
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedData) {
                    const msg = 'You have unsaved behavior marks that will be lost. Save or sync your data first.';
                    e.returnValue = msg;
                    return msg;
                }
            });
            
            initialize();
        });
    </script>
</body>
</html>
